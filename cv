import streamlit as st
import docx2txt
from PyPDF2 import PdfReader

st.set_page_config(page_title="CV Scoring Tool", page_icon="üìÑ", layout="centered")

st.title("üìÑ CV Scoring Tool - General Qualification (Test Version)")

st.markdown("""
This tool evaluates **General Qualification (15%)** based on World Bank-style criteria  
for a **Contract Management Specialist / Team Leader** role.
""")

# --- Define scoring rules ---
SCORING_RULES = {
    "phd": 1.00,
    "doctor": 1.00,
    "master": 0.95,
    "m.tech": 0.95,
    "m.e": 0.95,
    "bachelor": 0.90,
    "b.tech": 0.90,
    "b.e": 0.90,
    "diploma": 0.70,
    "civil": 1.00,  # to ensure Civil is detected as relevant
}

FULL_MARKS = 17.25  # total marks for General Qualification (15% weightage)

# --- Upload section ---
uploaded_file = st.file_uploader("üì§ Upload the candidate's CV (PDF or DOCX):", type=["pdf", "docx"])

if uploaded_file:
    # Extract text based on file type
    if uploaded_file.name.endswith(".pdf"):
        reader = PdfReader(uploaded_file)
        text = "\n".join(page.extract_text() for page in reader.pages if page.extract_text())
    else:
        text = docx2txt.process(uploaded_file)

    text_lower = text.lower()

    # --- Detect degree keywords ---
    matched_levels = [key for key in SCORING_RULES.keys() if key in text_lower]

    if matched_levels:
        # choose the highest rating (best qualification found)
        best_match = max(matched_levels, key=lambda k: SCORING_RULES[k])
        rating = SCORING_RULES[best_match]
        score = round(FULL_MARKS * rating, 2)

        st.success(f"üéì Detected qualification: **{best_match.title()}**")
        st.metric("General Qualification Score", f"{score} / {FULL_MARKS}")
        st.progress(rating)
    else:
        st.warning("No relevant qualification keywords found in the CV. Please verify manually.")

    with st.expander("üîç View extracted text"):
        st.text_area("CV Content Preview", text, height=300)

else:
    st.info("üëÜ Upload a PDF or DOCX resume to begin scoring.")
